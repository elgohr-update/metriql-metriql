WITH
event1 AS (
    SELECT {{#if report.dimensions}}{{dimension report.dimensions}} as dimension,{{/if}}
           {{connectors query.connectors report.firstStep.modelName}} as connector,
           date_trunc('{{report.dateUnit}}', min({{mapping columnTypes.EVENT_TIMESTAMP report.firstStep.modelName}})) AS date
    FROM {{modelTarget report.firstStep.modelName}}
    WHERE {{mapping columnTypes.EVENT_TIMESTAMP report.firstStep.modelName}} BETWEEN TIMESTAMP '{{variables.dateRange.start}}' AND TIMESTAMP '{{plusDate variables.dateRange.end "days" 1}}' AND {{filter report.firstStep}}
    GROUP BY 1 {{#if report.dimensions}}, 2{{/if}}
),
event2 AS (
    SELECT {{#if report.dimensions}}{{dimension report.dimensions}} as dimension,{{/if}}
           {{connectors query.connectors report.returningStep.modelName}} as connector,
           {{mapping columnTypes.EVENT_TIMESTAMP report.returningStep.modelName}} as date
    FROM {{modelTarget report.returningStep.modelName}}
    WHERE {{mapping columnTypes.EVENT_TIMESTAMP report.returningStep.modelName}} BETWEEN TIMESTAMP '{{variables.dateRange.start}}' AND TIMESTAMP '{{plusDate variables.dateRange.end "days" 1}}' AND {{filter report.returningStep}}
)
SELECT {{#if report.dimensions}} event1.dimension {{else}} CAST(event1.date as DATE) {{/if}} as dimension,
CASE WHEN event2.date IS NULL OR datediff('{{report.dateUnit}}', event1.date, event2.date) = 0 THEN null ELSE DATEDIFF('{{report.dateUnit}}', event1.date, event2.date) END AS lead,
COUNT(DISTINCT event2.connector) AS count
FROM event1
LEFT JOIN event2 ON (event1.connector = event2.connector AND {{#if report.dimensions}} event1.dimension = event2.dimension AND {{/if}} event2.date >= event1.date)
GROUP BY 1, 2